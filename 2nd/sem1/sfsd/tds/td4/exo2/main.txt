CONST G_FILENAME = "test"

CONST G_KEY_1 = 'key-1'
CONST G_KEY_2 = 'key-2'

CONST G_SFILENAME_BASE = 's-test' // split file base name 

TYPE Record = RECORD {
    key: STRING
    // other fields
}

FUNCTION splitFile(filename: STRING, sfilename: STRING, key1: string, key2: string)
    DECLARE 
        file: FILE OF Record BUFFER(buf, buf1, buf2, buf3) HEADER(bnum, bf) // bf here stands for blocking factor
        sfiles: ARRAY<FILE OF Record HEADER(bnum, bf)>[3]
        i: INTEGER
    BEGIN
        file = OPEN(filename, 'A')
        sfiles = [OPEN(sfilename + '-' + STRING(n)) FOR n IN [1..3]]

        FOR i = 0, i < bnum DO
            BEGIN
                buf = READ_BLOCK(file, i)
                FOR record IN buf DO
                    BEGIN
                        // add record to the exact buffer
                        IF record.key < key1 THEN APPEND_BUFFER(buf1, record)
                        ELSE IF record.key >= key1 AND record.key < key2 THEN APPEND_BUFFER(buf2, record)
                        ELSE APPEND_BUFFER(buf3, record)
                        
                        // append the block once it reaches the blocking factor
                        IF LENGTH_BUFFER(buf1) == bf THEN APPEND_BLOCK(sfiles[0], buf1)
                        IF LENGTH_BUFFER(buf2) == bf THEN APPEND_BLOCK(sfiles[1], buf2)
                        IF LENGTH_BUFFER(buf3) == bf THEN APPEND_BLOCK(sfiles[2], buf3)
                    END   
            END
        
        CLOSE file
        FOR i = 0, i < 3 DO CLOSE sfiles[i]
        RETURN NULL
    END


FUNCTION main()
    BEGIN
        splitFile(G_FILENAME, G_SFILENAME_BASE, G_KEY_1, G_KEY_2)
    END
